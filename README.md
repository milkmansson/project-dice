# Project D.I.C.E.: A small Toit project showcasing MEMS capabilities
'Dynamic Inertial Computing of Entropy': Rolling up entropy of motion.

## History
A short while ago I began a project to create a digital random number 
generator/dice loaded with a choice of 'bad' randomness and 'good' 
randomness, with the purpose of illustrating (to customers) the impact 
to a simple scenario such as a well-known physical board game.  This began 
in Arduino - not being a professional developer, I eventually got stuck
in the complexities of managing multithreading/multitasking on the platform.
The project stalled.  Since discovering Toit, its virutal machines, 
task/scheduling, etc, I realised I didn't have to solve those problems 
myself, or rely on complex libraries I couldn't troubleshoot.  This is
a small Toit reincarnation of that project - with code and ideas robbed
from it, minus the entropy/cryptography lesson, plus a little polish -
in an attempt to turn this into a complete product simple enough for
kids to use.

## About this project
This is a digital dice, which uses motion data generated by moving it 
to create randomness for a dice roll. I've attempted to push the 
boundaries of what is possible - the intention is not to have **any** 
other interfaces, eg, external buttons.  Any/all interactions (even
configuration choices) will be performed by only by movement.  (Features
have been used both to test and further refine development of this
[Toit MPU6050 driver/library](https://www.github.com/milkmansson/toit-mpu6050)
implementation.)

## Parts Required
I built this with parts I had on hand.  Construction with other hardware
and drivers is definitely possible, but may require some work.
- Toit - The platform needs to be installed on your ESP32, follow the
  instructions found here.
- ESP32 based DFRobot ESP32c6 Beetle (for the size constraints and very
  basic battery management built-in.)
- MPU6050 I2C based motion sensing device.  (It could be argued that
  newer devices would be better choices, however this module is still
  cheaply available and good enough for this use case.  When I have other
  devices to hand, they cans be incorporated!) 
- SSD1306 I2C based OLED Screen.
- LED and resistor for indicating state (Optional).
- Connecting wires and other minor materials.
- Lipo battery compatible with ESP32 board, and the expected device
  enclosure.  (Note polarity of the JST connector on commercial battery
  modules from overseas - these may not be the same as your ESP32 when
  they arrive.)

## How it works (State Machine)
| Stage | Interaction | Behind the scenes |
| - | - | - |
| 1 | Pick up the device to turn it 'On'. | Movement sense triggers interrupt waking ESP from deep sleep |
| 2 | Set it down so it learns which way is 'up' (the screen provides guidance). | Code examines movement and creates a calibration of 'up' |
| 3 | Shake up or down to select dice type (interactions via screen) | Using calibration and tuned timing/wait states, select from the menu. Obtain initial selection from storage, and save selected option to storage for later. |
| 4 | Set the device down for 15s to make the selection | Timer elapses, and selection (nim-roll/max-roll) selected |
| 5 | Shake the device, numbers adjust internally | Whilst waiting for the device to be set down, continutally consume data from the sensor, and roll together |
| 6 | When set down, display the 'roll' (plus distribution data, for interest) | Use a mathematical function to reduce collected data into a selection.  Display distribution data, and optionally save the distribution data to non volatile (flash) storage. |
| 7 | Wait.  Do another roll when moved (goto 5). | Use zero-motion-to-motion detection on the sensor to determine if shaking or resting |
| 8 | After 120s, go to deep sleep (off).  | Using monotonic time, wait for a (configurable) timer to expire and run the ESP32 command. |

## Worked examples/techniques in the source code
- Use of I2C throughout.
- Toit `pixel-display` driver and creating a display interface with both
  fixed and dynamic fields.
- Use of SSD1306 (via I2C).
- Use of MPU6050 (via I2C) and it's many features such as Motion Detection,
  and the use of the Gyroscope and Accelerometer.
- Task Scheduling on Toit.
- Interrupts via GPIO on ESP32/Toit.

## Versions

#### v1.0.0 This version
- Most features implemented.
- Menu selection incomplete, but underway.

#### To Do list: v(next)
- Provide better screen feedback about battery and charge.
- Provide a more interesting movement animation - perhaps a realtime plot/
  animation of force.
- Have generated data sent to an online destination, for better statistical
  analysis.  (Include integration with Toit BLE Wifi provisioning package.)
- Integrate an SRAM chip (like the 47L16) instead of flash for saving data, to
  help save flash lifetime when collecting roll distribution data, and the
  desire to save it every roll.
- Code integration with Artemis (use being optional) - for no other reason
  than to push whats possible, including OTA firmware updates.
- Refine module selection - find a better ESP32 model with better battery
  management integrated.
- Experiment/integrate with other MEMS sensors, potentially implement AHRS, ftw.
  (If you are able to donate one, this would accelerate development!).

## Issues
If there are any issues, changes, or any other kind of feedback, please
[raise an issue](https://github.com/milkmansson/project-dice/issues). Feedback/
suggestions are welcome and appreciated!

## Disclaimer
- All trademarks belong to their respective owners.
- No warranties for this work, express or implied.

## Credits
- [Florian](https://github.com/floitsch) for the tireless help and encouragement
- The wider Toit developer team (past and present) for a truly excellent product
- AI has been used for code and text reviews, analysing and compiling data and
  results, and assisting with ensuring accuracy.  Its been a long time since
  high-school calculus, so I have leaned into AI to accelerate some of the
  mathematical elements. 

## About Toit
One would assume you are here because you know what Toit is.  If you dont:
> Toit is a high-level, memory-safe language, with container/VM technology built
> specifically for microcontrollers (not a desktop language port). It gives fast
> iteration (live reloads over Wi-Fi in seconds), robust serviceability, and
> performance thatâ€™s far closer to C than typical scripting options on the
> ESP32. [[link](https://toitlang.org/)]
- [Review on Soracom](https://soracom.io/blog/internet-of-microcontrollers-made-easy-with-toit-x-soracom/)
- [Review on eeJournal](https://www.eejournal.com/article/its-time-to-get-toit)

